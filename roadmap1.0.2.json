{
  "roadmap_version": "1.0.2",
  "project": "maatify/security-guard",
  "note": "v1.0.2 introduces the new unified SecurityEventDTO architecture and shifts phase numbering forward accordingly.",

  "core_dependencies": {
    "storage_layer": "maatify/data-adapters",
    "fake_layer": "maatify/data-fakes",
    "contracts": "maatify/common",
    "rules": [
      "All MySQL, Redis, and MongoDB access MUST go through AdapterInterface",
      "All real execution MUST use maatify/data-adapters",
      "All fake execution and adapter behavior tests MUST use maatify/data-fakes",
      "Direct PDO, Redis, or MongoDB client usage inside security-guard is forbidden"
    ]
  },

  "phases": [

    {
      "id": "phase1",
      "title": "Environment Setup",
      "version": "1.0.0",
      "status": "completed",
      "summary": "Project bootstrap, Composer setup, testing environment, and namespace preparation.",
      "tracks": {
        "core": {
          "tasks": [
            "Create GitHub repository",
            "Initialize Composer project",
            "Prepare .env.example",
            "Setup autoloading namespaces"
          ],
          "outputs": [
            "composer.json",
            ".env.example"
          ]
        },
        "tests": {
          "tasks": [
            "Setup PHPUnit",
            "Prepare CI environment"
          ],
          "outputs": [
            "tests/bootstrap.php"
          ]
        },
        "examples": {
          "tasks": [],
          "outputs": []
        }
      }
    },

    {
      "id": "phase2",
      "title": "Core Architecture & DTOs",
      "version": "1.0.0",
      "status": "completed",
      "summary": "Finalize core DTO structures, interfaces, and the high-level Facade.",
      "tracks": {
        "core": {
          "tasks": [
            "Create LoginAttemptDTO",
            "Create SecurityBlockDTO (final int-based timestamps version)",
            "Design SecurityGuardDriverInterface",
            "Create AbstractSecurityGuardDriver",
            "Create SecurityGuardService (Facade)",
            "IdentifierStrategy integration",
            "Normalization + block encoding/decoding",
            "Prepare config loader"
          ],
          "outputs": [
            "src/DTO/LoginAttemptDTO.php",
            "src/DTO/SecurityBlockDTO.php",
            "src/Contracts/SecurityGuardDriverInterface.php",
            "src/Drivers/AbstractSecurityGuardDriver.php",
            "src/Service/SecurityGuardService.php",
            "src/Identifier/Contracts/IdentifierStrategyInterface.php",
            "src/Config/SecurityConfigLoader.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase3",
      "title": "Driver Implementations",
      "version": "1.0.0",
      "status": "completed",
      "summary": "Implement all Security Guard storage drivers on top of maatify/data-adapters.",
      "tracks": {
        "core": {
          "tasks": [
            "Implement RedisSecurityGuard using RedisClientProxy",
            "Implement PdoMySQLDriver",
            "Implement DbalMySQLDriver",
            "Implement MySQLSecurityGuard",
            "Implement MongoSecurityGuard",
            "Create SecurityGuardResolver",
            "Fix PHPStan generics + safe casting",
            "Unify block/unblock/cleanup behavior",
            "Normalize identifier using strategy"
          ],
          "outputs": [
            "src/Drivers/RedisSecurityGuard.php",
            "src/Drivers/MySQL/PdoMySQLDriver.php",
            "src/Drivers/MySQL/DbalMySQLDriver.php",
            "src/Drivers/MySQL/MySQLSecurityGuard.php",
            "src/Drivers/Mongo/MongoSecurityGuard.php",
            "src/Drivers/Support/RedisClientProxy.php",
            "src/Resolver/SecurityGuardResolver.php"
          ],
          "changes": [
            "RedisSecurityGuard now fully uses RedisClientProxy abstraction",
            "PdoMySQLDriver: fixed fetchColumn|false logic + strict int timestamps",
            "DbalMySQLDriver: safe casting + consistent SQL + REPLACE INTO support",
            "MySQLSecurityGuard delegates to PDO/DBAL transparently",
            "MongoSecurityGuard rewritten with proper Collection handling + indexes",
            "Resolver fixed to match MongoDatabase instead of MongoClient",
            "Resolver refactored to remove unreachable conditions",
            "Redis proxy unified commands: hGet, hSet, hDel, hGetAll, expire, del, info",
            "Abstract driver now strictly validates block payload during decodeBlock()"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase4",
      "title": "Unified Security Events (NEW)",
      "version": "1.0.0",
      "status": "completed",
      "summary": "Introduce unified SecurityEventDTO and event normalization across all security actions.",
      "tracks": {
        "core": {
          "tasks": [
            "Create SecurityEventDTO (action/platform/userId/userType/context)",
            "Create SecurityEventTypeEnum",
            "Refactor LoginAttemptDTO to extend SecurityEventDTO",
            "Introduce SecurityEventFactory",
            "Unify event timestamps",
            "Normalize subject/platform/action rules",
            "Ensure driver compatibility with unified event model"
          ],
          "outputs": [
            "src/DTO/SecurityEventDTO.php",
            "src/Enums/SecurityEventTypeEnum.php",
            "src/DTO/LoginAttemptDTO.php",
            "src/Event/SecurityEventFactory.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": {
          "tasks": [],
          "outputs": [
            "docs/phases/README.phase4.md"
          ]
        }
      }
    },

    {
      "id": "phase5",
      "title": "Core Logic & Service Layer",
      "version": "1.0.0",
      "status": "completed",
      "summary": "Main security orchestration logic built on top of unified security events.",
      "tracks": {
        "core": {
          "tasks": [
            "handleEvent() logic",
            "handleAttempt() logic",
            "Reset on success",
            "Block/unblock logic",
            "IP failure counters",
            "Expose isBlocked()",
            "ENV thresholds integration"
          ],
          "outputs": [
            "src/SecurityGuardService.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },
    {
      "id": "phase5_5",
      "title": "IntegrationV2 Stabilization",
      "version": "1.0.1",
      "status": "in_progress",
      "summary": "Stabilize IntegrationV2 as the single authoritative source of real infrastructure behavior, define explicit infrastructure contracts, and eliminate ambiguous or unsafe integration assumptions.",
      "tracks": {
        "core": {
          "tasks": [],
          "outputs": []
        },
        "tests": {
          "tasks": [
            "Create IntegrationV2 test layer",
            "Enforce resolver-based adapter creation",
            "Deprecate legacy integration tests",
            "Exclude legacy integration tests from PHPUnit execution",
            "Validate Redis/MySQL/Mongo real behavior using real infrastructure",
            "Fail explicitly when infrastructure is unavailable",
            "Define explicit MySQL schema contract for IntegrationV2 tests",
            "Provide schema bootstrap or documentation for MySQL IntegrationV2",
            "Ensure MySQL integration tests fail clearly when schema is missing",
            "Eliminate PHPUnit risky tests by enforcing explicit assertions or intent markers"
          ],
          "rules": [
            "IntegrationV2 is the ONLY source of truth for real infrastructure behavior",
            "Legacy integration tests are deprecated and excluded",
            "No mocks, fakes, or hardcoded hosts allowed in IntegrationV2",
            "All adapters MUST be resolved via DatabaseResolver + EnvironmentLoader",
            "Security Guard MUST NOT auto-create or auto-migrate database schemas",
            "Integration tests MUST clearly document all external infrastructure expectations"
          ],
          "outputs": [
            "tests/IntegrationV2/",
            "tests/IntegrationV2/MySQL/schema.sql",
            "tests/IntegrationV2/MySQL/README.md",
            "tests/Integration/README.md",
            "phpunit.xml.dist (exclude legacy integration)",
            "docs/integration/INTEGRATION_V2_CONTRACT.md"
          ]
        },
        "examples": {
          "tasks": [],
          "outputs": []
        }
      }
    },


    {
      "id": "phase6",
      "title": "Config Normalization & DTO Injection Layer",
      "version": "1.1.0",
      "status": "pending",
      "summary": "Introduce strict DTO-based configuration model. Eliminate all internal defaults and ensure the library is fully controlled by host-provided configuration.",
      "tracks": {
        "core": {
          "tasks": [
            "Design SecurityGuardConfigDTO as the single configuration entry point",
            "Design ActionRateLimitConfigDTO",
            "Design GlobalRateLimitConfigDTO",
            "Design BackoffPolicyConfigDTO",
            "Remove all internal default configuration logic",
            "Ensure all runtime logic consumes DTOs only"
          ],
          "outputs": [
            "src/Config/DTO/SecurityGuardConfigDTO.php",
            "src/Config/DTO/ActionRateLimitConfigDTO.php",
            "src/Config/DTO/GlobalRateLimitConfigDTO.php",
            "src/Config/DTO/BackoffPolicyConfigDTO.php"
          ]
        },
        "tests": {
          "tasks": [
            "Validate DTO acceptance",
            "Validate resolver wiring using DTOs"
          ],
          "outputs": []
        },
        "examples": {
          "tasks": [
            "Document host-driven configuration injection flow"
          ],
          "outputs": [
            "docs/phases/README.phase6.md"
          ]
        }
      }
    },

    {
      "id": "phase7",
      "title": "Global Rate Limiter Overlay Enforcement",
      "version": "1.1.1",
      "status": "pending",
      "summary": "Introduce a real global rate limiter overlay that executes before all action-level enforcement using a dedicated DTO-based configuration.",
      "tracks": {
        "core": {
          "tasks": [
            "Introduce GlobalRateLimiter enforcement layer",
            "Ensure global limiter executes before action limiter",
            "Ensure global limiter uses GlobalRateLimitConfigDTO only",
            "Add explicit source attribution for global violations"
          ],
          "outputs": [
            "src/RateLimit/GlobalRateLimiter.php",
            "src/Enforcement/EnforcingRateLimiter.php"
          ]
        },
        "tests": {
          "tasks": [
            "Unit tests for global-before-action enforcement order",
            "Integration tests using Redis adapter"
          ],
          "outputs": []
        },
        "examples": {
          "tasks": [],
          "outputs": []
        }
      }
    },

    {
      "id": "phase8",
      "title": "Backoff Policy Hardening & banTime Integration",
      "version": "1.1.2",
      "status": "pending",
      "summary": "Upgrade exponential backoff logic to a deterministic punishment strategy governed fully by DTO-provided policy, including banTime integration.",
      "tracks": {
        "core": {
          "tasks": [
            "Introduce BackoffPolicyInterface",
            "Implement ExponentialBackoffPolicy using BackoffPolicyConfigDTO",
            "Integrate banTime as a hard cap on calculated delays",
            "Remove any implicit backoff assumptions"
          ],
          "outputs": [
            "src/Backoff/BackoffPolicyInterface.php",
            "src/Backoff/ExponentialBackoffPolicy.php"
          ]
        },
        "tests": {
          "tasks": [
            "Unit tests for backoff calculation",
            "Ensure banTime cap is respected"
          ],
          "outputs": []
        },
        "examples": {
          "tasks": [],
          "outputs": []
        }
      }
    },

    {
      "id": "phase9",
      "title": "Phase 5 Coverage Completion & Validation",
      "version": "1.1.3",
      "status": "pending",
      "summary": "Complete missing tests for Phase 5 core logic and enforcement layers to ensure production-grade stability.",
      "tracks": {
        "core": {
          "tasks": [
            "No production code changes allowed"
          ],
          "outputs": []
        },
        "tests": {
          "tasks": [
            "Cover EnforcingRateLimiter logic",
            "Cover GlobalRateLimiter enforcement",
            "Cover BackoffPolicy behavior",
            "Use real Redis adapter only (no mocks)"
          ],
          "outputs": [
            "tests/RateLimit/",
            "tests/Backoff/"
          ]
        },
        "examples": {
          "tasks": [],
          "outputs": []
        }
      }
    },

    {
      "id": "phase10",
      "title": "Internal API Freeze (No Public Release)",
      "version": "1.2.0",
      "status": "pending",
      "summary": "Freeze internal APIs for stabilization and validation. No public release, no tags, no Packagist publishing.",
      "tracks": {
        "core": {
          "tasks": [
            "Lock public API surface",
            "Prohibit breaking changes without major version bump",
            "Tag stable release"
          ],
          "outputs": [
            "CHANGELOG.md",
            "README.md"
          ]
        },
        "tests": {
          "tasks": [
            "Final CI validation",
            "Coverage threshold enforcement"
          ],
          "outputs": []
        },
        "examples": {
          "tasks": [
            "Final integration documentation"
          ],
          "outputs": [
            "docs/phases/README.phase10.md"
          ]
        }
      }
    },

    {
      "id": "phase11",
      "title": "Rate Limiter Bridge",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Integration with maatify/rate-limiter using unified event pipeline.",
      "tracks": {
        "core": {
          "tasks": [
            "Design event hooks",
            "Implement bridge listener",
            "Forward rate-limit violations as SecurityEventDTO"
          ],
          "outputs": [
            "src/Bridge/RateLimiterBridge.php"
          ]
        },
        "tests": {
          "tasks": [
            "Flood attack testing"
          ],
          "outputs": []
        },
        "examples": {
          "tasks": [
            "Manual integration support",
            "Documentation"
          ],
          "outputs": [
            "docs/phases/README.phase6.md"
          ]
        }
      }
    },

    {
      "id": "phase12",
      "title": "Audit DTO & Storage",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Introduce audit event DTO and base storage abstraction.",
      "tracks": {
        "core": {
          "tasks": [
            "Create AuditEventDTO",
            "Define AuditStorageInterface",
            "Implement base audit repository via maatify/data-adapters"
          ],
          "outputs": [
            "src/Audit/AuditEventDTO.php",
            "src/Audit/Contracts/AuditStorageInterface.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase13",
      "title": "Mongo Audit Forwarding",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Forward unified audit events into MongoDB collections.",
      "tracks": {
        "core": {
          "tasks": [
            "Create Mongo audit driver",
            "TTL index setup",
            "Fallback handling via resolver"
          ],
          "outputs": [
            "src/Audit/Drivers/MongoAuditDriver.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase14",
      "title": "Audit History API",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Expose security audit history.",
      "tracks": {
        "core": {
          "tasks": [
            "Audit query service",
            "Pagination",
            "Date range filtering"
          ],
          "outputs": [
            "src/Audit/AuditHistoryService.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase15",
      "title": "Audit Filters & Indexes",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Advanced filtering and indexing.",
      "tracks": {
        "core": {
          "tasks": [
            "IP filtering",
            "User type filtering",
            "Composite indexes"
          ],
          "outputs": [
            "docs/phases/README.phase10.md"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase16",
      "title": "PSR Logger Integration",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Structured logging for security actions.",
      "tracks": {
        "core": {
          "tasks": [
            "Inject PSR logger",
            "Log block/unblock actions",
            "Log suspicious patterns"
          ],
          "outputs": [
            "src/Logging/SecurityLogger.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase17",
      "title": "Telegram Alerts",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Real-time alerts via Telegram bot.",
      "tracks": {
        "core": {
          "tasks": [
            "Telegram notifier",
            "Configurable alert channels",
            "Critical alert levels"
          ],
          "outputs": [
            "src/Alerts/TelegramAlertService.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase18",
      "title": "Webhook Dispatcher",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Generic webhook dispatcher.",
      "tracks": {
        "core": {
          "tasks": [
            "Webhook payload schema",
            "POST dispatcher",
            "Async retry policy"
          ],
          "outputs": [
            "src/Webhook/WebhookDispatcher.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase19",
      "title": "Retry Engine & Delivery Tests",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Reliable delivery system.",
      "tracks": {
        "core": {
          "tasks": [
            "Retry queue",
            "Backoff strategy",
            "Failure simulations"
          ],
          "outputs": []
        },
        "tests": {
          "tasks": [],
          "outputs": [
            "tests/Webhook/RetryTest.php"
          ]
        },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase20",
      "title": "Monitoring APIs",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Monitoring endpoints and admin API controls.",
      "tracks": {
        "core": {
          "tasks": [
            "Health endpoint",
            "Stats endpoint",
            "Manual unblock API"
          ],
          "outputs": [
            "src/Monitoring/SecurityMetricsService.php"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase21",
      "title": "Unit Consistency Tests",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Validate driver parity.",
      "tracks": {
        "core": { "tasks": [], "outputs": [] },
        "tests": {
          "tasks": [
            "Driver parity tests",
            "Edge case consistency"
          ],
          "outputs": [
            "tests/Consistency/"
          ]
        },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase22",
      "title": "Attack Simulations",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Simulate distributed and burst attacks.",
      "tracks": {
        "core": { "tasks": [], "outputs": [] },
        "tests": {
          "tasks": [
            "Multi-IP brute force",
            "Burst login attempts"
          ],
          "outputs": [
            "tests/Simulation/"
          ]
        },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase23",
      "title": "Redis & Mongo Stress",
      "version": "1.0.0",
      "status": "pending",
      "summary": "High-load performance stress tests.",
      "tracks": {
        "core": { "tasks": [], "outputs": [] },
        "tests": {
          "tasks": [
            "Redis load",
            "Mongo TTL stress"
          ],
          "outputs": [
            "tests/Stress/"
          ]
        },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase24",
      "title": "Coverage Hardening",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Achieve stable 85%+ coverage.",
      "tracks": {
        "core": { "tasks": [], "outputs": [] },
        "tests": {
          "tasks": [
            "Coverage gap analysis",
            "Critical path coverage enforcement"
          ],
          "outputs": [
            "coverage/"
          ]
        },
        "examples": { "tasks": [], "outputs": [] }
      }
    },

    {
      "id": "phase25",
      "title": "Documentation & Packagist Release",
      "version": "1.0.0",
      "status": "pending",
      "summary": "Finalize documentation & release.",
      "tracks": {
        "core": {
          "tasks": [
            "README.md",
            "CHANGELOG.md",
            "Phase documentation",
            "Packagist publishing",
            "Integration validation"
          ],
          "outputs": [
            "README.md",
            "CHANGELOG.md"
          ]
        },
        "tests": { "tasks": [], "outputs": [] },
        "examples": { "tasks": [], "outputs": [] }
      }
    }

  ],

  "testing_policy": {
    "phpunit": "latest",
    "phpstan": "level-max",
    "psr": ["PSR-4", "PSR-12", "PSR-3", "PSR-14 (events)"],
    "rules": [
      "Legacy integration tests must not run in CI",
      "IntegrationV2 tests require real infrastructure",
      "Unit tests may use data-fakes",
      "Coverage tests must not rely on real infrastructure",
      "No test exists to make CI green; tests exist to protect production"
    ]
  }
}
